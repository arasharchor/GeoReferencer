<?php 
$fileIsUploaded = false;
$error = null;
if (isset($_POST['submit']) && !empty($_FILES["file"])) {
    if (in_array($_FILES['file']['type'], ['image/jpeg', 'image/png', 'image/gif', 'image/tiff', 'image/jp2'])) {
        $fileName = md5(basename($_FILES["file"]["name"]) . microtime());
        $targetFile = '/assets/images/' . $fileName;
        if (move_uploaded_file($_FILES["file"]["tmp_name"], $targetFile)) {
            $fileIsUploaded = true;
        } else {
            $fileIsUploaded = false;
        }
    } else {
        $fileIsUploaded = false;
        $error = 'Unsuported file format!';
    }
}
?>
<!DOCTYPE html>
<html lang="en">
    <head>
        <base href="/">
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Georeferencer Utility Demo</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" type="text/css" href="/dist/css/vendors.css" />
        <link rel="stylesheet" type="text/css" href="/dist/css/app.css" />
        
        <!--[if lte IE 9]>
            <script src="{{API_URL}}/xdomain/xdomain.min.js" slave="{{API_URL}}/xdomain/proxy.html"></script>
        <![endif]-->
    </head>
    <body>
        <?php if (!$fileIsUploaded) { ?>
            <form method="post" enctype="multipart/form-data" class="upload">
                <h4>Upload a new map</h4>
                <?php if ($error !== null) { ?>
                    <span class="error"><?php echo $error; ?></span>
                <?php } ?>
                <input type="text" name="title" placeholder="Title" value="<?php echo isset($_POST['title']) ?: ''; ?>"/>
                <textarea name="description" placeholder="Description"><?php echo isset($_POST['description']) ?: ''; ?></textarea>
                <input type="text" name="place" placeholder="Place" value="<?php echo isset($_POST['place']) ?: ''; ?>"/>
                <div class="relative">
                    <input type="file" id="file" name="file" class="fileupload" onchange="changeFileName(this);" />
                    <label for="file" class="fileuptext">Upload Image</label>
                    <span id="filename"></span>
                    <input type="submit" value="Start" name="submit" />
                </div>    
                <div class="clear"></div>
            </form>
            <script>
                function changeFileName(elem) {
                    document.getElementById('filename').innerHTML = elem.value.replace(/.*\\/g, '');
                }
            </script>
        <?php } else { ?>
            <georeferencer />

            <script type="text/javascript" src="//maps.google.com/maps/api/js?v=3&sensor=false"></script>
            <script type="text/javascript" src="/dist/js/app-deps.min.js"></script>
            <script type="text/javascript" src="/dist/js/app-partials.min.js"></script>
            <script type="text/javascript" src="/dist/js/app.js"></script>

            <script>
                angular.element(document).ready(function () {
                    angular.module('Georeferencer.Boot')
                        .run(function (GeoState, GeoImage) {
                            var image = GeoImage.$new({
                                'url': '{{API_URL}}/file/<?php echo $fileName; ?>',
                                'title': '<?php echo addslashes($_POST['title']); ?>',
                                'description': '<?php echo addslashes($_POST['description']); ?>',
                                'place': '<?php echo addslashes($_POST['place']); ?>'
                            });
                            GeoState.setImage(image);
                        });
                    angular.bootstrap(document, ['Georeferencer.Boot'])
                });
            </script>
        <?php } ?>
    </body>
</html>
